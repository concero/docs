# Concero CCIP
## Overview

The user-facing cross-chain infrastructure of Concero can be split into three parts:

#### Single-chain Execution Layer
Responsible for executing single-chain transactions on both the source and destination chains. Performs swaps on Decentralised Exchanges and obtains bridgeable tokens in cases of cross-chain transactions.

#### Cross-chain Execution Layer
Fast-tracks the cross-chain asset migration by utilising liquidity in the Cross-Chain Pool Infrastructure. Releases the transaction on the destination chain, while its settlement is in progress.

#### Settlement layer
Performs value transfer across two chains. Settles the transaction within 30 minutes by repaying the optimistic loan taken by the execution layer.

### Schematic overview

![Logo](/ccip.png)

# Single-chain token swaps

## Off-chain pathfinding

Off-chain Pathfinding algorithm computes the most optimal transaction route, passes it to frontend, which generates call data for the user's wallet to execute in the `swap()` or `swapAndBridge()` functions of `Orchestrator.sol`

## Orchestrator contract

Orchestrator manages the entire transaction on its chain. It determines whether a token needs to be swapped via `DexSwap`, bridged via `ConceroBridge` or both. It accepts user tokens in  `swap()`, `bridge()` or `swapAndBridge()`.

## DexSwap contract

Only takes calls from the `Orchestrator` contract which contain an array of swaps that are required to be performed on the current chain. Executes each swap one-by-one on multiple dexes, in order to obtain a destination token.

# Bridging & Settlement

## Chainlink Functions

Serve the purpose of fast-tracking transactions while CCIP is performing the 24-minute bridging.

### SRC Functions

Calls `addUnconfirmedTX()` function on the DST chain to indicate that a transaction has entered CCIP on the source chain. Uses a private key in DON-Hosted secrets in order to call the function via an allow-listed messenger wallet. The DST contract, which receives such call immediately begins the confirmation process by running an additional set of Chainlink Functions on the destination chain.

### DST Functions

The purpose of Destination chain ChainlinkFunctions is to confirm whether the transaction has indeed been submitted to the source chain and has successfully entered CCIP. Using Alchemy, Infura and other RPC providers inside the JS code, it performs an RPC call to read a specific event, which confirms that the transaction is being sent through CCIP.

Additionally, DST functions are responsible for awaiting a certain amount of block confirmations before submitting a successful callback to the DST contract. The minimum of block confirmations depends on the risk factor of each transaction that enters the bridging infrastructure. This itself is a combination of weighted factors such as the amount of transactions, transaction history of the wallet, and any other anomalies that the transaction might have.

## Chainlink CCIP

Chainlink CCIP is chosen as a reliable and secure settlement layer due to its complex multi-layered architecture. As soon as funds enter CCIP on the SRC chain, a corresponding event is emitted and Chainlink Functions begin the acceleration process. When the funds have been taken from the liquidity pool in a form of a 24-minute loan, CCIP rebalances that pool by completing the transaction.

## Liquidity pools

Liquidity pools are a crucial part of Concero's fast-track solution, as they hold the liquidity necessary to be taken as a loan while CCIP is in process of bridging the assets. As soon as the transaction is confirmed by Chainlink Functions on the DST chain, the Orchestrator contract obtains a loan from the Liquidity pool and proceeds to execute all necessary actions, such as destination chain swaps. This is in order to send the destination asset to the user's wallet.

## Orchestrator contract

The Orchestrator contract serves as an operations manager for the entire on-chain system. It's isolating the environment from malicious actors, by exclusively operating each contract in a predetermined order, such that there is no possibility for the end user or any external entity to directly interact with internal contracts of our infrastructure. The Orchestrator provides a single external point of entry for the end user to facilitate cross-chain transactions.
